<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>2024 오바수 경품추첨!</title>
  <style>
    body {
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      height: 100vh;
      margin: 0;
      background-color: #f7f7f7;
    }
    h1 {
      font-size: 3em;
      font-weight: bold;
      text-align: center;
      margin-bottom: 50px;
    }
    #slot-machine {
      display: flex;
      justify-content: center;
      align-items: center;
      font-size: 5em;
      font-weight: bold;
    }
    .number {
      width: 100px;
      text-align: center;
      background-color: #eee;
      margin: 0 10px;
      padding: 20px;
      border-radius: 10px;
    }
    #result {
      margin-top: 50px;
      font-size: 2em;
      font-weight: bold;
      color: red;
    }
    #draw-btn {
      padding: 15px 30px;
      font-size: 1.5em;
      margin-top: 30px;
      cursor: pointer;
    }
    #history {
      margin-top: 20px;
      font-size: 1.2em;
      color: #333;
    }
  </style>
</head>
<body>

  <h1>2024 오바수 경품추첨!</h1>

  <div id="slot-machine">
    <div id="num1" class="number">0</div>
    <div id="num2" class="number">0</div>
    <div id="num3" class="number">0</div>
  </div>

  <div id="result"></div>

  <button id="draw-btn">다음 당첨번호 추첨</button>

  <div id="history"></div> <!-- 당첨 번호 이력 표시 -->

  <script>
    const minNum = 1;
    const maxNum = 100; // 설정한 숫자 범위
    let alreadyWon = []; // 이미 당첨된 번호를 추적
    let drawCount = 0; // 당첨 횟수 추적
    let spinSpeed = 100; // 숫자가 도는 속도 (ms)
    let stopDelay = 1000; // 각 숫자가 멈추는 시간 차이 (ms)

    // 사용자별 보유 번호 설정
    let userTickets = [
      { name: '사용자1', tickets: [1] },
      { name: '사용자2', tickets: [4, 5, 6] },
      { name: '사용자3', tickets: [6, 8,2] }
    ];

    // 모든 가능한 번호 배열
    const allNumbers = Array.from({ length: maxNum - minNum + 1 }, (_, i) => i + minNum);

    // 이미 당첨된 사용자들을 추적
    let wonUsers = [];

    function getRandomNumber() {
      return Math.floor(Math.random() * 10);
    }

    function getWinningNumber() {
      // 1. 사용자별로 한 번만 당첨되도록, 이미 당첨된 사용자는 배제
      let availableUserTickets = userTickets
        .filter(user => !wonUsers.includes(user.name)) // 이미 당첨된 사용자는 배제
        .flatMap(user => user.tickets.filter(ticket => !alreadyWon.includes(ticket)));

      // 2. 사용자들이 가진 번호가 다 당첨되었을 경우, minNum ~ maxNum 범위의 번호 중 아직 당첨되지 않은 번호를 필터링
      let availableNumbers = allNumbers.filter(num => !alreadyWon.includes(num));

      // 3. 당첨할 번호가 없을 경우
      if (availableUserTickets.length === 0 && availableNumbers.length === 0) {
        alert("더 이상 당첨할 번호가 없습니다!");
        return null;
      }

        // 4. 사용자 번호와 일반 번호를 합쳐 하나의 풀(pool)로 만든다
        let combinedPool = [...availableNumbers, ...availableUserTickets ];

        // 5. 합쳐진 풀에서 랜덤으로 당첨 번호 추첨
        let winningNumber = combinedPool[Math.floor(Math.random() * combinedPool.length)];


      // 5. 당첨된 번호 기록
      alreadyWon.push(winningNumber);

      // 6. 해당 번호를 가진 사용자가 있으면, 그 사용자의 모든 번호를 제외
      userTickets.forEach(user => {
        if (user.tickets.includes(winningNumber)) {
          wonUsers.push(user.name); // 해당 사용자는 한 번만 당첨
          alreadyWon.push(...user.tickets); // 그 사용자의 모든 티켓을 당첨 목록에 추가
        }
      });

      drawCount++; // 당첨 횟수 증가
      return winningNumber;
    }

    function spinSlotMachine(winningNumber) {
      if (winningNumber === null) return;

      const num1 = document.getElementById('num1');
      const num2 = document.getElementById('num2');
      const num3 = document.getElementById('num3');
      const result = document.getElementById('result');
      const history = document.getElementById('history');

      let digit1 = Math.floor(winningNumber / 100);
      let digit2 = Math.floor((winningNumber % 100) / 10);
      let digit3 = winningNumber % 10;

      // 슬롯이 도는 애니메이션을 위한 setInterval 함수
      let interval1, interval2, interval3;
      interval1 = setInterval(() => { num1.textContent = getRandomNumber(); }, spinSpeed);
      interval2 = setInterval(() => { num2.textContent = getRandomNumber(); }, spinSpeed);
      interval3 = setInterval(() => { num3.textContent = getRandomNumber(); }, spinSpeed);

      // 첫 번째 숫자를 멈추기
      setTimeout(() => {
        clearInterval(interval1);
        num1.textContent = digit1;
      }, stopDelay);

      // 두 번째 숫자를 멈추기
      setTimeout(() => {
        clearInterval(interval2);
        num2.textContent = digit2;
      }, stopDelay * 2);

      // 세 번째 숫자를 멈추기
      setTimeout(() => {
        clearInterval(interval3);
        num3.textContent = digit3;
        result.textContent = "당첨! 번호: " + winningNumber;

        // 당첨 이력에 표시
        const drawHistory = document.createElement('div');
        drawHistory.textContent = `${drawCount}차: 당첨번호 ${winningNumber}`;
        history.appendChild(drawHistory);
      }, stopDelay * 3);
    }

    document.getElementById('draw-btn').addEventListener('click', function() {
      const winningNumber = getWinningNumber();
      spinSlotMachine(winningNumber);
    });
  </script>
</body>
</html>
